# Example GitLab CI/CD configuration with DRS
#
# This example shows how to integrate DRS AI reviews into your existing pipeline
# without blocking your main build/test/deploy workflow.

stages:
  - review    # AI review runs in parallel with tests
  - test
  - build
  - deploy

# Include DRS template
include:
  - remote: 'https://raw.githubusercontent.com/manojlds/drs/main/src/ci/gitlab-ci.template.yml'

# =============================================================================
# AI Review Jobs (run in parallel with your main pipeline)
# =============================================================================

# Full AI review with all agents
ai_review:
  extends: .drs_review
  stage: review  # Runs in parallel with test stage
  variables:
    REVIEW_AGENTS: "security,quality,style,performance"
  # allow_failure: true means this won't block your pipeline
  allow_failure: true

# Security-only review (faster, can block on critical issues)
ai_review_security:
  extends: .drs_review
  stage: review
  variables:
    REVIEW_AGENTS: "security"
  # Set to false to block pipeline on security issues
  allow_failure: false

# =============================================================================
# Your existing pipeline jobs (run in parallel with AI review)
# =============================================================================

# Run tests
test:
  stage: test
  image: node:20
  script:
    - npm install
    - npm test
  # Tests run in parallel with AI review

# Build application
build:
  stage: build
  image: node:20
  script:
    - npm install
    - npm run build
  artifacts:
    paths:
      - dist/
  needs: ["test"]  # Only needs tests, not AI review

# Deploy (example)
deploy:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying..."
  needs: ["build"]  # Only needs build, not AI review
  only:
    - main
