name: DRS PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenCode CLI
        run: npm install -g opencode-ai

      - name: Install dependencies
        run: npm ci

      - name: Build DRS
        run: npm run build

      - name: Setup OpenCode Zen Authentication
        if: env.OPENCODE_ZEN_API_KEY != ''
        env:
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          echo "ðŸ”‘ Setting up OpenCode Zen authentication..."
          mkdir -p ~/.local/share/opencode
          cat > ~/.local/share/opencode/auth.json <<EOF
          {
            "opencode": {
              "type": "api",
              "key": "${OPENCODE_ZEN_API_KEY}"
            }
          }
          EOF
          echo "âœ… OpenCode Zen auth.json created"

      - name: Review Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          echo "ðŸš€ Starting PR review with OpenCode (in-process mode)..."

          node dist/cli/index.js review-pr \
            --owner ${{ github.event.repository.owner.login }} \
            --repo ${{ github.event.repository.name }} \
            --pr ${{ github.event.pull_request.number }} \
            --post-comments
